"""
Drawing canvas with simple crayon-like drawing.

This module provides a child-friendly drawing interface with
simple color selection and brush sizes.
"""

import pygame
import os
from datetime import datetime
from typing import List, Tuple, Optional, Callable

from ..config.settings import Settings
from ..ui.button import Button
from ..ui.voice_controls import VoiceControls
from ..audio.voice_manager import VoiceManager


class DrawingCanvas:
    """Simple drawing canvas for children."""

    def __init__(
        self, screen: pygame.Surface, settings: Settings, switch_state: Callable, voice_manager: Optional[VoiceManager] = None
    ) -> None:
        """
        Initialize the drawing canvas.

        Args:
            screen: The pygame surface to draw on.
            settings: Application settings.
            switch_state: Callback function to switch application state.
            voice_manager: Optional voice manager for text-to-speech.
        """
        self.screen = screen
        self.settings = settings
        self.switch_state = switch_state
        self.voice_manager = voice_manager

        # Title font
        self.title_font = pygame.font.Font(None, 72)
        self.title_text = "Free Drawing"
        self.title_color = self.settings.colors["primary"]

        # Drawing state
        self.drawing = False
        self.current_color = self.settings.drawing_colors[0]
        self.current_brush_size = self.settings.default_brush_size
        self.last_pos: Optional[Tuple[int, int]] = None
        self.first_draw = True  # Flag to speak welcome message

        # Create canvas surface
        self.canvas = pygame.Surface((self.settings.screen_width, self.settings.screen_height))
        self.canvas.fill((255, 255, 255))  # White canvas

        # Back button (top-left corner)
        self.back_button = Button(
            20,
            20,
            150,
            60,
            "Back",
            (100, 100, 100),
            on_click=self._go_back,
            tooltip="Return to main menu",
        )

        # Create brush size buttons (left side, below back button)
        self.size_buttons: List[Button] = []
        self._create_brush_sizes()

        # Create color palette buttons (left side, below size buttons)
        self.color_buttons: List[Button] = []
        self._create_color_palette()

        # Clear button
        self.clear_button = Button(
            self.settings.screen_width - 180,
            self.settings.screen_height - 150,
            150,
            60,
            "Clear",
            (200, 50, 50),
            on_click=self._clear_canvas,
            tooltip="Clear the drawing",
        )

        # Save button
        self.save_button = Button(
            self.settings.screen_width - 180,
            self.settings.screen_height - 80,
            150,
            60,
            "Save",
            (50, 150, 200),
            on_click=self._save_drawing,
            tooltip="Save drawing to Downloads/Toddler Drawings folder",
        )

        # Voice controls (positioned to not overlap with back button)
        self.voice_controls: Optional[VoiceControls] = None
        if self.voice_manager:
            self.voice_controls = VoiceControls(
                settings.screen_width,
                settings.screen_height,
                voice_manager
            )

    def _go_back(self) -> None:
        """Return to main menu."""
        from ..main import AppState

        self.switch_state(AppState.MENU)

    def _create_brush_sizes(self) -> None:
        """Create brush size selection buttons with visual circles."""
        button_size = 70
        spacing = 10
        start_x = 20
        start_y = 100

        for i, size in enumerate(self.settings.brush_sizes):
            button = Button(
                start_x,
                start_y + i * (button_size + spacing),
                button_size,
                button_size,
                "",  # No text - will draw circle instead
                self.settings.colors["secondary"],
                on_click=lambda s=size: self._set_brush_size(s),
                tooltip=f"Brush size: {size}",
            )
            # Store the brush size for visual rendering
            button.brush_size = size
            self.size_buttons.append(button)

    def _create_color_palette(self) -> None:
        """Create color selection buttons below size buttons."""
        button_size = 70
        spacing = 10
        start_x = 20
        # Start colors below the size buttons
        # 4 size buttons at 70px each + 3 spacings of 10px + starting position 100
        start_y = 100 + (len(self.settings.brush_sizes) * (70 + spacing)) + 20

        for i, color in enumerate(self.settings.drawing_colors):
            button = Button(
                start_x,
                start_y + i * (button_size + spacing),
                button_size,
                button_size,
                "",
                color,
                on_click=lambda c=color: self._set_color(c),
            )
            self.color_buttons.append(button)

    def _set_color(self, color: Tuple[int, int, int]) -> None:
        """
        Set the current drawing color.

        Args:
            color: RGB color tuple.
        """
        self.current_color = color

    def _set_brush_size(self, size: int) -> None:
        """
        Set the current brush size.

        Args:
            size: Brush size in pixels.
        """
        self.current_brush_size = size

    def _clear_canvas(self) -> None:
        """Clear the drawing canvas."""
        self.canvas.fill((255, 255, 255))

    def _save_drawing(self) -> None:
        """Save the current drawing to the Downloads/Toddler Drawings folder."""
        try:
            # Get downloads folder
            downloads_folder = os.path.join(os.path.expanduser("~"), "Downloads")

            # Create Toddler Drawings subfolder
            toddler_drawings_folder = os.path.join(downloads_folder, "Toddler Drawings")
            os.makedirs(toddler_drawings_folder, exist_ok=True)

            # Create filename with timestamp
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"toddler_drawing_{timestamp}.png"
            filepath = os.path.join(toddler_drawings_folder, filename)

            # Save the canvas
            pygame.image.save(self.canvas, filepath)

            # Announce save success
            if self.voice_controls:
                self.voice_controls.speak(f"Drawing saved!")

            print(f"Drawing saved to: {filepath}")
        except Exception as e:
            print(f"Error saving drawing: {e}")
            if self.voice_controls:
                self.voice_controls.speak("Sorry, could not save the drawing")

    def handle_event(self, event: pygame.event.Event) -> None:
        """
        Handle pygame events.

        Args:
            event: The pygame event to handle.
        """
        # Handle UI buttons
        for button in self.color_buttons + self.size_buttons + [self.clear_button, self.save_button, self.back_button]:
            button.handle_event(event)

        # Handle voice controls
        if self.voice_controls:
            self.voice_controls.handle_event(event)

        # Handle drawing
        if event.type == pygame.MOUSEBUTTONDOWN:
            if event.button == 1:  # Left click
                self.drawing = True
                self.last_pos = event.pos

        elif event.type == pygame.MOUSEBUTTONUP:
            if event.button == 1:
                self.drawing = False
                self.last_pos = None

        elif event.type == pygame.MOUSEMOTION:
            if self.drawing and self.last_pos:
                # Draw line from last position to current position
                pygame.draw.line(
                    self.canvas,
                    self.current_color,
                    self.last_pos,
                    event.pos,
                    self.current_brush_size,
                )
                # Draw circle at current position for smooth line
                pygame.draw.circle(
                    self.canvas, self.current_color, event.pos, self.current_brush_size // 2
                )
                self.last_pos = event.pos

    def update(self) -> None:
        """Update drawing state."""
        pass

    def draw(self) -> None:
        """Draw the canvas and UI."""
        # Speak welcome message on first draw
        if self.first_draw and self.voice_controls:
            self.voice_controls.speak("Welcome to drawing! Choose a color and start creating")
            self.first_draw = False

        # Draw the canvas
        self.screen.blit(self.canvas, (0, 0))

        # Draw title at the top center
        title_y = 40
        title_surface = self.title_font.render(self.title_text, True, self.title_color)
        title_rect = title_surface.get_rect(center=(self.settings.screen_width // 2, title_y))

        # Add shadow effect to title
        shadow_surface = self.title_font.render(self.title_text, True, (0, 0, 0))
        shadow_rect = shadow_surface.get_rect(
            center=(self.settings.screen_width // 2 + 3, title_y + 3)
        )
        self.screen.blit(shadow_surface, shadow_rect)
        self.screen.blit(title_surface, title_rect)

        # Draw UI elements on top
        for button in self.color_buttons:
            button.draw(self.screen)

        # Draw size buttons with visual circles
        for button in self.size_buttons:
            button.draw(self.screen)
            # Draw a visual circle on the button to represent the brush size
            if hasattr(button, 'brush_size'):
                circle_radius = button.brush_size // 2
                # Make sure the circle fits within the button
                max_radius = min(button.width, button.height) // 2 - 5
                circle_radius = min(circle_radius, max_radius)

                # Draw circle in the center of the button
                center_x = button.x + button.width // 2
                center_y = button.y + button.height // 2
                pygame.draw.circle(self.screen, (240, 240, 240), (center_x, center_y), circle_radius)

        self.clear_button.draw(self.screen)
        self.save_button.draw(self.screen)
        self.back_button.draw(self.screen)

        # Draw voice controls
        if self.voice_controls:
            self.voice_controls.draw(self.screen)

        # Draw tooltips on top
        for button in self.color_buttons:
            button.draw_tooltip(self.screen)
        for button in self.size_buttons:
            button.draw_tooltip(self.screen)
        self.clear_button.draw_tooltip(self.screen)
        self.save_button.draw_tooltip(self.screen)
        self.back_button.draw_tooltip(self.screen)
        if self.voice_controls:
            self.voice_controls.mute_button.draw_tooltip(self.screen)
            self.voice_controls.repeat_button.draw_tooltip(self.screen)
